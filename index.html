<html>
  <head>
    <!-- Moralis SDK code -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
  </head>
  <body>
    <h1>Gas Stats With Moralis</h1>

    <button id="btn-login">Moralis Login</button>
    <button id="btn-logout">Logout</button>
    <button id="btn-claim_div">Claim Dividend</button>
    <button id="btn-get-stats">Refresh Stats</button>

    <script>

      //const web3 = await Moralis.enableWeb3();
      //const contract = new web3.eth.Contract(contractAbi, contractAddress);

      // connect to Moralis server

      const serverUrl = "https://fb4lgk90k9q6.usemoralis.com:2053/server";
      const appId = "ktHvEa2Fvn9b9GkvZaJ5khsa1BHu404GsuHvxZ38";
      Moralis.start({ serverUrl, appId });

      async function login() {
        let user = Moralis.User.current();
        if (!user) {
          user = await Moralis.Web3.authenticate();
        }
        console.log("logged in user:", user);
        getStats();
      }
      async function logOut() {
        await Moralis.User.logOut();
        console.log("logged out");
      }
      // bind button click handlers
      document.getElementById("btn-login").onclick = login;
      document.getElementById("btn-logout").onclick = logOut;
      document.getElementById("btn-claim_div").onclick = claimDiv;
      document.getElementById("btn-get-stats").onclick = getStats;
      
      function getStats() {
        const user = Moralis.User.current();
        if (user) {
          getUserTransactions(user);
        }
      }
      
      async function getUserTransactions(user) {
        // create query
        const query = new Moralis.Query("EthTransactions");
        query.equalTo("from_address", user.get("ethAddress"));
        // run query
        const results = await query.find();
        console.log("user transactions:", results);
      }
      
      //get stats on page load
      getStats();

      

      // get token balances
      async function getBalance() {

        const user = Moralis.User.current()
        const user_address = user.get("ethAddress")
        
        const options = { chain: 'bsc', address: user_address }
        const balances = await Moralis.Web3API.account.getTokenBalances(options);
        //var user_balance_JSON = balances.filter( element => element.name == "EverGrow Coin")
        var user_balance_JSON = balances.filter( element => element.token_address == "0xc001bbe2b87079294c63ece98bdd0a88d761434e" )
        var user_balance_EGC = (user_balance_JSON[0].balance / 1e9).toFixed(3)
        console.log("full balances", balances);
        console.log("balances:", user_balance_EGC);
        document.getElementById("total_balance").innerHTML = user_balance_EGC;
      };
      getBalance();


      async function getPrice() {
        //Get token price on PancakeSwap v2 BSC
        const options = {
          address: "0xC001BBe2B87079294C63EcE98BdD0a88D761434e",
          chain: "bsc",
          exchange: "PancakeSwapv2"
        };
        const price = await Moralis.Web3API.token.getTokenPrice(options);
        console.log("price:", price.usdPrice)
        document.getElementById("the_price").innerHTML = price.usdPrice;
        }
      getPrice();

      // interact with main contract: 0xC001BBe2B87079294C63EcE98BdD0a88D761434e

      async function getSupply() {
        //Read smart contract from EVM and return circulating supply
        const ABI = [{"inputs":[],"name":"getCirculatingSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        const options_supply = {
          chain: "bsc",
          address: "0xC001BBe2B87079294C63EcE98BdD0a88D761434e",
          function_name: "getCirculatingSupply",
          abi: ABI
        };
        const circulating = await Moralis.Web3API.native.runContractFunction(options_supply);
        const supply = (circulating / 1e9).toFixed(3)
        console.log("supply:", supply)
        document.getElementById("the_supply").innerHTML = supply;
        }
      getSupply();

      async function getTotalDistributed() {
        //Read smart contract from EVM and return circulating supply
        const ABI = [{"inputs":[],"name":"totalDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];
        const options_distributed = {
          chain: "bsc",
          address: "0xfbAb1D829e36EFbD13642229EAe2964004f38C41",
          function_name: "totalDistributed",
          abi: ABI
        };
        const distributed = await Moralis.Web3API.native.runContractFunction(options_distributed);
        const distributed_float = (distributed / 1e18).toFixed(3)
        console.log("distributed:", distributed_float)
        document.getElementById("the_distribution").innerHTML = distributed_float;
        }
      getTotalDistributed();
      
      // interact with dividend contract: 0xfbAb1D829e36EFbD13642229EAe2964004f38C41

      const dividend_ABI = [{"inputs":[{"internalType":"address","name":"_router","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"claimDividend","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"dividendsPerShare","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"dividendsPerShareAccuracyFactor","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"shareholder","type":"address"}],"name":"getUnpaidEarnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minDistribution","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"gas","type":"uint256"}],"name":"process","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_minPeriod","type":"uint256"},{"internalType":"uint256","name":"_minDistribution","type":"uint256"}],"name":"setDistributionCriteria","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"shareholder","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"setShare","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"shares","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"totalExcluded","type":"uint256"},{"internalType":"uint256","name":"totalRealised","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalDividends","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

      async function getUnpaid() {
        //Read smart contract from EVM and return unpaid dividends
        
        const user = Moralis.User.current()
        const user_address = user.get("ethAddress")
        const options_unpaid = {
          chain: "bsc",
          address: "0xfbAb1D829e36EFbD13642229EAe2964004f38C41",
          function_name: "getUnpaidEarnings",
          abi: dividend_ABI,
          params: {shareholder: user_address}
        };
        const unpaid = await Moralis.Web3API.native.runContractFunction(options_unpaid);
        const unpaid_float = (unpaid / 1e18).toFixed(3)
        console.log("unpaid:", unpaid_float)
        document.getElementById("the_unpaid").innerHTML = unpaid_float;

      };
      getUnpaid();

      async function claimDiv() {
        // claim unpaid dividends
        
        const options = {
          contractAddress: "0xfbAb1D829e36EFbD13642229EAe2964004f38C41",
          functionName: "claimDividend",
          abi: dividend_ABI,
          chain: "bsc",
          params: {
            // double-check appropriate router address
            _router: "0x10ED43C718714eb63d5aA57B78B54704E256024E"
          }
        };

        // seems to activate before pressing button...
        const web3 = await Moralis.enableWeb3();

        const receipt = await Moralis.executeFunction(options);
        console.log(receipt)
        claimDiv();
      };
      


    </script>

  <h1>Current Price: <span id="the_price"></span></h1>
  <h1>Circulating Supply: <span id="the_supply"></span></h1>
  <h1>Total Distributed: <span id="the_distribution"></span></h1>
  <h1>Total Balance: <span id="total_balance"></span></h1>
  <h1>Unpaid Balance: <span id="the_unpaid"></span></h1>

  </body>
</html>
